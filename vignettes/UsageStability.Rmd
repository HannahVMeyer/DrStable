---
title: "Finding stable components of dimensionality reduction"
author: "Hannah Meyer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
devtools::load_all()
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r libraries}
library(PhenotypeSimulator)
```


# 1. Simulate Data

```{r data simulation, cache=TRUE}
alpha <- c(0, 0.3, 0.5, 0.7)
Y <- lapply(alpha, function(alpha) {
    simulation <- runSimulation(N = 1000, P = 50, tNrSNP = 10000, 
                           SNPfrequencies = c(0.05, 0.1,0.3,0.4), genVar = 0.4,
                           h2s=0.05, h2bg = 0.95, phi = 0.6, seed=alpha*10,
                           delta=0.4, nonlinear="exp", 
                           proportionNonlinear=alpha)
    return(simulation$phenoComponentsFinal$Y)
})
names(Y) <- paste("nonlinear", alpha, sep="")
```

# 2. Run dimensionality reduction

```{r dimensionality reduction, cache=TRUE}
dr <- lapply(Y, function(y) {
    subsetDimReduction(Y=y, seed=2+10*alpha, method="PCA", verbose=TRUE, nrSubsets = 10)
})
```

# 3. Find stable components

```{r stable components, cache=TRUE}
stability <- lapply(dr, function(x) {
    estimateStability(x, threshold=c(0.8, 0.9, 0.95), verbose=TRUE)
})
```

# 4. Plot stability
```{r plot stability, fig.show='hold'}
overviewPlots <- lapply(stability, plotStability)
tt <- lapply(overviewPlots, function(x) print(x$pass))
tt <- lapply(overviewPlots, function(x) print(x$corr))
```